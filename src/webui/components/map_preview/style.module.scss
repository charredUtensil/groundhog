@property --pvw-yaw {
  syntax: "<angle>";
  inherits: true;
  initial-value: 0deg;
}
@property --pvw-pitch {
  syntax: "<angle>";
  inherits: true;
  initial-value: 0deg;
}
@property --pvw-tr-x {
  syntax: "<length>";
  inherits: true;
  initial-value: 0px;
}
@property --pvw-tr-y {
  syntax: "<length>";
  inherits: true;
  initial-value: 0px;
}
@property --pvw-scale {
  syntax: "<number>";
  inherits: true;
  initial-value: 1;
}
@keyframes scan-scrim {
  0% {
    background-position-x: -800px;
  }
  100% {
    background-position-x: 0;
  }
}

.cavernPreview {
  position: absolute;
  overflow: hidden;
  width: 100%;
  height: 100%;

  --pvw-bpak: #222222;
  --pvw-bpck: #2d004b;
  --pvw-bphk: #166921;
  --pvw-pathspan: yellow;
  --pvw-pathaux: #24b136;
  --pvw-entfriend: yellow;
  --pvw-entenemy: red;
  --pvw-dfluid: #080022;
  --pvw-dfloor: #180032;
  --pvw-dwall: #2d004b;
  --pvw-scale0: #555544;
  --pvw-scale1: #777744;
  --pvw-scale2: #999944;
  --pvw-scale3: #bbbb44;
  --pvw-scale4: #dddd44;
  --pvw-scale5: #ffff44;
  --pvw-scale6: #ffff66;
  --pvw-scale7: #ffff88;
  --pvw-tile1: #2d004b;
  --pvw-tile2: #180032;
  --pvw-tile3: #180032;
  --pvw-tile4: #180032;
  --pvw-tile5: #180032;
  --pvw-tile6: #ff5a00;
  --pvw-tile11: #002fb5;
  --pvw-tile12: #166921;
  --pvw-tile14: #bfbfbf;
  --pvw-tile24: #9d9b00;
  --pvw-tile26: #ad59ef;
  --pvw-tile30: #943cc3;
  --pvw-tile34: #731cad;
  --pvw-tile38: #800080;
  --pvw-tile42: #b5ff00;
  --pvw-tile46: #9c4108;
  --pvw-tile50: #ffff00;
  --pvw-tile60: #180032;
  --pvw-tile61: #180032;
  --pvw-tile62: #180032;
  --pvw-tile63: #180032;
  --pvw-disco0: #ffff44;
  --pvw-disco1: #882222;
  --pvw-oxex: #555533;
  --pvw-oxhc: var(--pvw-tile42);
  --pvw-overscrim: var(--palette-settings-bg);

  .map {
    position: absolute;
    transition: transform 1s linear;
    transform:
      scale(var(--pvw-scale))
      rotate3d(1, 0, 0, var(--pvw-pitch))
      rotate(var(--pvw-yaw))
      translate(var(--pvw-tr-x), var(--pvw-tr-y));

    .baseplate {
      font-family: var(--font-tiny);
      font-size: 8px;

      .fg {
        fill: white;
      }

      &.ambiguousKind .bg {
        fill: var(--pvw-bpak);
      }

      &.caveKind .bg {
        fill: var(--pvw-bpck);
      }

      &.hallKind .bg {
        fill: var(--pvw-bphk);
      }
    }

    .path {
      stroke-linecap: round;
      stroke-dasharray: 2, 3;

      &.ambiguousKind {
        --fg-color: white;
        --fg-opacity: 0.3;
      }

      &.spanningKind {
        --fg-color: var(--pvw-pathspan);
      }

      &.auxiliaryKind {
        --fg-color: var(--pvw-pathaux);
      }

      & > path {
        stroke: var(--fg-color);
        stroke-opacity: var(--fg-opacity);
        stroke-width: 2px;
      }

      & > text {
        fill: var(--fg-color);
        opacity: var(--fg-opacity);
        font-family: var(--font-tiny);
        font-size: 12px;
      }
    }

    .plan {
      --color-bg: #444444;
      --color-fg: white;
      &.caveKind .bg {
        stroke-width: 2px;
        fill: none;
      }
      &.hallKind {
        .bg {
          stroke-linecap: round;
          opacity: 0.4;
        }
        &.spanningPathKind {
          --color-fg: var(--pvw-pathspan);
        }
        &.auxiliaryPathKind {
          --color-fg: var(--pvw-pathaux);
        }
      }
      &.fluid6 {
        --color-bg: var(--pvw-tile6);
      }
      &.fluid11 {
        --color-bg: var(--pvw-tile11);
      }
      &.left .label {
        text-anchor: end;
      }
      &.inline .label {
        text-anchor: middle;
        font-size: 6px;
      }
      .label {
        fill: var(--color-fg);
        font-size: 12px;
      }
      .pointer {
        fill: none;
        stroke-width: 1px;
        stroke: var(--color-fg);
      }
      .bg {
        stroke: var(--color-bg);
      }
    }

    .pearl {
      &.innerPearl {
        stroke-width: 1px;
        &.caveKind {
          --color0: #40ffff;
          --color1: #40dddd;
          --color2: #40bbbb;
          --color3: #409999;
        }
        &.hallKind {
          --color0: #ffff20;
          --color1: #dddd20;
          --color2: #bbbb20;
          --color3: #999920;
        }
      }
      &.outerPearl {
        stroke-width: 0.5px;
        --color0: #999999;
        --color1: #888888;
        --color2: #777777;
        --color3: #666666;
      }
      .layer {
        &.layer0 {
          stroke: var(--color0);
        }
        &.layer1 {
          stroke: var(--color1);
        }
        &.layer2 {
          stroke: var(--color2);
        }
        &.layer3 {
          stroke: var(--color3);
        }
      }
    }

    .tiles {
      shape-rendering: crispEdges;

      .bounds {
        fill: none;
      }

      &.oly-entities,
      &.oly-tiles {
        .bounds {
          fill: var(--pvw-tile38);
        }
      }
    }

    .height {
      shape-rendering: crispEdges;
    }

    .entity {
      --color-fg: var(--pvw-entfriend);
      &.enemy {
        --color-fg: var(--pvw-entenemy);
      }
      .marker {
        fill: var(--color-fg);
        stroke: black;
        stroke-width: 0.5px;
      }
      .label {
        fill: black;
        font-family: "Outfit";
        font-size: 2px;
        text-anchor: middle;
      }
    }

    .openCaveFlag {
      stroke: red;
      fill: white;
    }
  }

  .grid {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;

    background: var(--palette-settings-bg);
    
    &::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;

      background-image:
        linear-gradient(
          to left,
          transparent 0px,
          var(--palette-accent) 25px,
          transparent 400px);
      background-size: 800px 100%;
      animation: scan-scrim 3s infinite linear;
      transition: opacity 250ms ease-out;
    }

    &.complete::before {
      opacity: 0;
      transition: opacity 1000ms ease-out;
    }
  
    &::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;

      background: var(--palette-bg);
      mask-composite: subtract;
      mask-image:
        linear-gradient(
          to right,
          white 16px,
          transparent 16px,
          transparent 17px,
          white 17px),
        linear-gradient(
          transparent 16px,
          black 16px,
          black 17px,
          transparent 17px);
      mask-size: 32px 32px;
    }
  }

  .stats {
    position: absolute;
    left: 0;
    bottom: 0;
    color: var(--palette-accent);
    background: var(--palette-bg);
    font-family: var(--font-tiny);
    font-size: 8px;
    max-width: 400px;
    border: 1px solid var(--palette-settings-bg);
    padding: 4px 14px;
    margin: 16px;

    > ul {
      padding: 0;

      > li {
        display: inline;

        &:not(:first-child) {
          padding-left: 16px;
        }
      }
    }
  }

  .error {
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    font-size: 24px;
    color: #f18686;
    font-family: var(--font-body);
    text-align: center;
    line-break: anywhere;
  }
}
